<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ è§†é¢‘ä¸‹è½½å™¨</title>

    <!-- Google Fonts & Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- å¼•å…¥ Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <style>
        /* ğŸŒŸ èƒŒæ™¯ï¼šæ¸å˜ + æ¨¡ç³Š */
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-attachment: fixed;
            font-family: 'Poppins', sans-serif;
            color: white;
        }

        /* ğŸŒŸ å®¹å™¨ï¼šæ¯›ç»ç’ƒé£æ ¼ */
        .container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        /* ğŸŒŸ è¾“å…¥æ¡†ç¾åŒ– */
        .form-control {
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* ğŸŒŸ æŒ‰é’®ç¾åŒ– */
        .btn-primary {
            background: linear-gradient(135deg, #ff7eb3, #ff758c);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            transition: 0.3s;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 120, 150, 0.4);
        }

        /* ğŸŒŸ æ—¥å¿—çª—å£ */
        #log_output {
            height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
        }

        /* ğŸŒŸ ä¸‹è½½é“¾æ¥ */
        .download-link {
            margin-top: 15px;
        }

        /* ğŸŒŸ æŒ‰é’®åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>

        let session_id = null;

        window.addEventListener("beforeunload", function () {
            navigator.sendBeacon("/stop_download");  // å‘é€è¯·æ±‚ï¼Œé€šçŸ¥æœåŠ¡å™¨åœæ­¢ä¸‹è½½
        });

        document.addEventListener("DOMContentLoaded", function() {
            var socket = io.connect(location.protocol + "//" + location.hostname + ":" + location.port);

            socket.on('connect', function() {
                console.log("WebSocket è¿æ¥æˆåŠŸï¼");
            });

            

            socket.on("session_id", function(data) {
                session_id = data.session_id;
                console.log("è·å–åˆ° session_id:", session_id);
            });

            socket.on("disconnect", function() {
                console.log("WebSocket è¿æ¥æ–­å¼€ï¼");
            });

            socket.on("error", function(err) {
                console.log("WebSocket é”™è¯¯:", err);
            });


            // ç›‘å¬ WebSocket æ¶ˆæ¯ï¼ŒåŠ¨æ€æ›´æ–°æ—¥å¿—
            socket.on("log", function(data) {
                console.log("æ”¶åˆ° WebSocket æ—¥å¿—:", data);  // è°ƒè¯•ä¿¡æ¯
                var logElement = document.getElementById("log_output");
                if (logElement) {
                    logElement.innerText += data.message + "\n";
                    logElement.scrollTop = logElement.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
                }
            });

            // ç›‘å¬ "æ£€æµ‹åˆ°æœåŠ¡å™¨å†…å­˜åœ¨è¯¥è§†é¢‘çš„ç¼“å­˜ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½" äº‹ä»¶
            socket.on("existing_file", function(data) {
                console.log("æ£€æµ‹åˆ°æœåŠ¡å™¨å†…å­˜åœ¨è¯¥è§†é¢‘çš„ç¼“å­˜ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½:", data.file_url);
                var downloadElement = document.getElementById("download_link");
                downloadElement.innerHTML = `<a href="${data.file_url}" target="_blank">ç‚¹å‡»è¿™é‡Œä¸‹è½½è§†é¢‘</a>`;
            });

            // ç›‘å¬ "ä¸‹è½½å®Œæˆ" äº‹ä»¶
            socket.on("download_complete", function(data) {
                console.log("ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶åœ°å€:", data.file_url);
                var downloadElement = document.getElementById("download_link");

                // æ›´æ–°ä¸‹è½½é“¾æ¥
                downloadElement.innerHTML = `<a href="${data.file_url}" target="_blank">ç‚¹å‡»è¿™é‡Œä¸‹è½½è§†é¢‘</a>`;
            });
        });

        // å‘é€ä¸‹è½½è¯·æ±‚çš„å‡½æ•°
        async function downloadVideo() {
            const url = document.getElementById("video-url").value; // è·å–ç”¨æˆ·è¾“å…¥çš„è§†é¢‘é“¾æ¥
            const quality = document.getElementById("video-quality").value; // è·å–ç”¨æˆ·é€‰æ‹©çš„ç”»è´¨
            const downloadElement = document.getElementById("download_link"); // è·å–ä¸‹è½½é“¾æ¥åŒºåŸŸ

            console.log("downloadVideo() å†… session_id:", session_id); // è°ƒè¯•æ—¥å¿—
            
            if (!url) { // å¦‚æœè¾“å…¥æ¡†ä¸ºç©º
                alert("è¯·è¾“å…¥é“¾æ¥ï¼"); // æç¤ºç”¨æˆ·è¾“å…¥é“¾æ¥
                return;
            }

            if (!session_id) { // å¦‚æœæ²¡æœ‰è·å–åˆ°session_id
                alert("session_id æœªè·å–ï¼Œè¯·åˆ·æ–°é¡µé¢"); // è¦æ±‚ç”¨æˆ·åˆ·æ–°ç•Œé¢
                return;
            }

            // æ¸…ç©ºæ—§çš„ä¸‹è½½é“¾æ¥ï¼Œé˜²æ­¢æ··æ·†
            downloadElement.innerHTML = "";

            // å‘é€ä¸‹è½½ POST è¯·æ±‚åˆ°æœåŠ¡å™¨
            try {
                const response = await fetch("/download", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: url, session_id: session_id, quality: quality }) // å‘é€ JSON æ•°æ®
                });

                // è§£ææœåŠ¡å™¨è¿”å›çš„ JSON ç»“æœ
                const result = await response.json();

                if (response.ok) { // å¦‚æœè¯·æ±‚æˆåŠŸ
                    alert("ä¸‹è½½å·²å®Œæˆ!"); // æç¤ºç”¨æˆ·ä¸‹è½½æ­£åœ¨è¿›è¡Œ
                } else { // å¦‚æœè¯·æ±‚å¤±è´¥
                    alert("ä¸‹è½½å¤±è´¥ï¼š" + result.error); // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                }
            } catch (error) {
                alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼");
                console.error("ä¸‹è½½è¯·æ±‚é”™è¯¯:", error);
            }
        }
    </script>

</head>
<body>
<div class="container">
    <h2>ğŸ¬ è§†é¢‘ä¸‹è½½å™¨</h2>

    <!-- è§†é¢‘é“¾æ¥è¾“å…¥æ¡† -->
    <div class="mb-3">
        <label for="video-url" class="form-label">è¯·è¾“å…¥è§†é¢‘é“¾æ¥ï¼š</label>
        <input type="text" class="form-control" id="video-url" placeholder="è¾“å…¥è§†é¢‘é“¾æ¥">
    </div>

    <!-- ç”»è´¨é€‰æ‹©ä¸‹æ‹‰èœå• -->
    <div class="mb-3">
        <label for="video-quality" class="form-label">é€‰æ‹©è§†é¢‘ç”»è´¨ï¼š</label>
        <select class="form-control" id="video-quality">
            <option value="best">æœ€ä½³ç”»è´¨</option>
            <option value="worst">æœ€ä½ç”»è´¨</option>
            <option value="137">1080p</option>
            <option value="136">720p</option>
            <option value="135">480p</option>
            <!-- ä½ å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šé€‰é¡¹ -->
        </select>
    </div>

    <!-- ä¸‹è½½æŒ‰é’® -->
    <div class="d-grid">
        <button id="download-btn" class="btn btn-primary" onclick="downloadVideo()">ğŸ“¥ å¼€å§‹ä¸‹è½½</button>
    </div>

    <!-- ä¸‹è½½æ—¥å¿— -->
    <h4 class="mt-4">ğŸ“œ ä¸‹è½½æ—¥å¿—ï¼š</h4>
    <pre id="log_output"></pre>

    <!-- ä¸‹è½½å®Œæˆåï¼Œæ˜¾ç¤ºä¸‹è½½åœ°å€ -->
    <div class="download-link">
        <h4>ğŸ“‚ ä¸‹è½½åœ°å€ï¼š</h4>
        <div id="download_link" ></div> 
    </div>
</div>
</body>
</html>
